---
title: "plantines"
output: pdf_document
date: "2025-07-21"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
# --- Cargar librerías y configurar ----
library(tidyverse)
library(readxl)
library(lubridate)
library(nlme)
library(fs)
if (!requireNamespace("ggrepel", quietly = TRUE)) install.packages("ggrepel")
library(ggrepel)
set.seed(42)

# --- Rutas y directorios ----
data_dir  <- "C:/Users/Gabriela Gutierrez/Downloads"
meas_file <- path(data_dir, "Medicion_plantines.xlsx")
env_file  <- path(data_dir, "env_acumulado_plantas.xlsx")
plots_dir <- "plots"
if (!dir_exists(plots_dir)) dir_create(plots_dir)

# --- Metadatos de fechas (hojas) ----
sheet_info <- tibble(
  sheet = 1:7,
  fecha = ymd(c("2025-03-18","2025-04-15","2025-04-28",
                "2025-05-12","2025-05-27","2025-06-09","2025-06-23"))
)

# --- Leer y combinar mediciones ----
raw_list <- sheet_info %>%
  mutate(data = map2(sheet, fecha, ~ read_excel(meas_file, sheet = .x) %>% mutate(fecha = .y))) %>%
  pull(data)

common_cols <- raw_list %>% map(names) %>% reduce(intersect)
meas_data   <- map_dfr(raw_list, ~ select(.x, all_of(common_cols)))

# --- Limpiar y pivotear ----
mediciones <- meas_data %>%
  set_names(c("trat_raw","planta","altura","dac","fecha")) %>%
  mutate(
    tratamiento = trat_raw %>% str_to_upper() %>% str_trim() %>% str_sub(1,2) %>%
      factor(levels = c("TA","TB","TC","TD")),
    planta      = as.character(planta),
    altura      = as.numeric(altura),
    dac         = as.numeric(dac)
  ) %>%
  select(-trat_raw) %>%
  pivot_longer(cols = c(altura, dac), names_to = "variable", values_to = "valor")

# --- Quitar duplicados y filtrar plantas ----
med_clean <- mediciones %>%
  distinct(tratamiento, planta, fecha, variable, valor, .keep_all = TRUE)
base_date   <- min(sheet_info$fecha)
plants_base <- med_clean %>% group_by(planta) %>% summarize(has_base = any(fecha == base_date)) %>% filter(has_base) %>% pull(planta)
med_clean    <- filter(med_clean, planta %in% plants_base)
valid_plants <- med_clean %>% group_by(planta) %>% filter(n_distinct(fecha) > 1) %>% pull(planta)
med_clean    <- filter(med_clean, planta %in% valid_plants)

# --- Datos ambientales acumulados ----
env_data <- read_excel(env_file) %>% mutate(fecha = as_date(fecha))

# --- Preparar dataframe para modelar (DAC) ----
df_model <- med_clean %>%
  filter(variable == "dac") %>%
  left_join(env_data, by = "fecha") %>%
  mutate(
    dia      = as.numeric(difftime(fecha, base_date, units = "days")),
    temp_cum = scale(temp_mean_cum),
    hum_cum  = scale(humedad_mean_cum),
    rad_cum  = scale(rad_mean_cum),
    rain_cum = scale(lluvia_sum_cum)
  )

# --- Definición de modelos ----
modelo1 <- lme(
  valor ~ tratamiento,
  random = ~1 | planta,
  data   = df_model,
  na.action = na.exclude
)

modelo2 <- lme(
  valor ~ dia + tratamiento,
  random = ~1 | planta,
  data   = df_model,
  na.action = na.exclude
)

modelo3 <- lme(
  valor ~ dia + tratamiento,
  random  = ~ 1 + dia | planta,
  data    = df_model,
  control = lmeControl(opt = "optim",
                       optimMethod = "BFGS",
                       maxIter      = 2000,
                       msMaxIter    = 2000),
  na.action = na.exclude
)

modelo4 <- lme(
  valor ~ dia + tratamiento + temp_cum,
  random = ~ 1 | planta,
  data   = df_model,
  method = "REML",
  na.action = na.exclude
)

modelo5 <- lme(
  valor ~ dia + tratamiento + temp_cum,
  random  = ~ 1 + dia | planta,
  data    = df_model,
  control = lmeControl(opt = "optim",
                       optimMethod = "BFGS",
                       maxIter      = 2000,
                       msMaxIter    = 2000),
  na.action = na.exclude
)

modelo6 <- lme(
  valor ~ dia + tratamiento + temp_cum + hum_cum + rad_cum + rain_cum,
  random  = ~ 1 + dia | planta,
  data    = df_model,
  control = lmeControl(opt = "optim",
                       optimMethod = "BFGS",
                       maxIter      = 2000,
                       msMaxIter    = 2000),
  na.action = na.exclude
)

modelo_pendiente_aletoria <- lme(
  valor ~ dia + tratamiento + temp_cum + hum_cum + rad_cum + rain_cum,
  random = ~ dia | planta,
  data   = df_model,
  method = "REML",
  control = lmeControl(opt = "optim"),
  na.action = na.exclude
)

modelo_int <- lme(
  valor ~ dia * tratamiento + temp_cum + hum_cum + rad_cum + rain_cum,
  random = ~ 1 | planta,
  data   = df_model,
  method = "REML",
  na.action = na.exclude
)

models <- list(
  M1 = modelo1,
  M2 = modelo2,
  M3 = modelo3,
  M4 = modelo4,
  M5 = modelo5,
  M6 = modelo6,
  M7 = modelo_pendiente_aletoria,
  M8 = modelo_int
)

# --- Comparación de modelos (AIC/BIC) ---
model_comp <- tibble(
  modelo = names(models),
  AIC    = map_dbl(models, AIC),
  BIC    = map_dbl(models, BIC)
)
print(model_comp)
```
```{r}
# --- Mostrar todos los summary uno por uno ---
walk2(models, names(models), ~ {
  cat("\n============================\n")
  cat("Resumen del modelo", .y, "\n")
  cat("============================\n")
  print(summary(.x))
})

```


```{r}
# --- Función de gráficas observados vs predichos por planta y tratamiento ----
plot_predictions <- function(planta_id, trat_id, var = "dac") {
  obs <- med_clean %>%
    filter(planta == planta_id, tratamiento == trat_id, variable == var) %>%
    arrange(fecha)
  if(nrow(obs) < 2) stop("No hay suficientes datos para la planta/tratamiento seleccionados.")

  # Incluir explicitamente la columna 'planta' para predict
  new_data <- obs %>%
    select(planta, fecha, tratamiento) %>%
    distinct() %>%
    mutate(
      dia = as.numeric(difftime(fecha, base_date, units = "days"))
    ) %>%
    left_join(env_data, by = "fecha") %>%
    mutate(
      temp_cum = scale(temp_mean_cum),
      hum_cum  = scale(humedad_mean_cum),
      rad_cum  = scale(rad_mean_cum),
      rain_cum = scale(lluvia_sum_cum)
    )

  preds <- map_dfr(names(models), function(mn) {
    tibble(
      fecha  = new_data$fecha,
      modelo = mn,
      pred   = predict(models[[mn]], newdata = new_data, level = 1)
    )
  })

  ggplot() +
    geom_point(data = obs, aes(x = fecha, y = valor), color = "black", size = 2) +
    geom_line(data = obs, aes(x = fecha, y = valor), color = "black", size = 0.7) +
    geom_line(data = preds, aes(x = fecha, y = pred, color = modelo), linetype = "dashed", size = 1) +
    labs(
      title = paste("Planta", planta_id, "- Tratamiento", trat_id),
      x     = "Fecha", y = var, color = "Modelo"
    ) +
    theme_minimal() +
    theme(axis.text.x = element_text(angle = 45, hjust = 1))
}

# --- Exportar gráficos de ejemplo ----
examples <- tribble(
  ~planta, ~tratamiento,
  "107",  "TA",
  "105",  "TB",
  "420",  "TC",
  "300",  "TD"
)
walk2(examples$planta, examples$tratamiento, ~ {
  p <- plot_predictions(.x, .y, "dac")
  print(p)
  ggsave(path(plots_dir, paste0("pred_", .x, "_", .y, "_dac.png")), p,
         width = 7, height = 5, dpi = 300)
})
```

```{r}

# --- Gráficas de perfil por tratamiento (altura y DAC) ---

dir_out <- plots_dir  
if (!dir.exists(dir_out)) dir.create(dir_out)

colores_trat <- c(
  "TA" = "#D62828",
  "TB" = "#2A9D8F",
  "TC" = "#E9C46A",
  "TD" = "#457B9D"
)

niveles_trat <- levels(med_clean$tratamiento)

# --- Perfil de ALTURA corregido ---
for (tr in niveles_trat) {
  df_altura_tr <- med_clean %>%
    filter(variable == "altura", tratamiento == tr) %>%
    arrange(planta, fecha)

  if (nrow(df_altura_tr) == 0) next

  # Sólo conservar filas con valor no NA
  df_altura_val <- df_altura_tr %>% filter(!is.na(valor))

  # Para cada planta, quedarnos con su última medición válida
  ultimos_altura <- df_altura_val %>%
    group_by(planta) %>%
    slice_max(fecha, with_ties = FALSE) %>%
    ungroup()

  p_alt <- ggplot(df_altura_tr, aes(x = fecha, y = valor, group = planta)) +
    geom_line(color = colores_trat[tr], size = 0.6, alpha = 0.6, na.rm = TRUE) +
    geom_point(color = colores_trat[tr], size = 0.8, alpha = 0.8, na.rm = TRUE) +
    geom_text(
      data = ultimos_altura,
      aes(label = planta),
      hjust = -0.1, vjust = 0.5, size = 3,
      color = colores_trat[tr], fontface = "bold"
    ) +
    scale_x_date(
      date_labels = "%b %d", date_breaks = "2 weeks",
      expand = expansion(mult = c(0.02, 0.12))
    ) +
    labs(
      title = paste0("Perfil de ALTURA – Tratamiento ", tr),
      x = "Fecha", y = "Altura (cm)"
    ) +
    theme_minimal(base_size = 12) +
    theme(
      plot.title  = element_text(size = 14, face = "bold", hjust = 0.5),
      axis.text.x = element_text(angle = 45, vjust = 0.6),
      panel.grid.minor = element_blank()
    )

  print(p_alt)
  ggsave(
    file.path(dir_out, paste0("perfil_altura_", tr, ".png")),
    p_alt, width = 7, height = 5, dpi = 300
  )
}
```

```{r}
# --- Perfil de DAC corregido ---
for (tr in niveles_trat) {
  df_dac_tr <- med_clean %>%
    filter(variable == "dac", tratamiento == tr) %>%
    arrange(planta, fecha)

  if (nrow(df_dac_tr) == 0) next

  # Sólo filas con valor no NA
  df_dac_val <- df_dac_tr %>% filter(!is.na(valor))

  # Última medición válida por planta
  ultimos_dac <- df_dac_val %>%
    group_by(planta) %>%
    slice_max(fecha, with_ties = FALSE) %>%
    ungroup()

  p_dac <- ggplot(df_dac_tr, aes(x = fecha, y = valor, group = planta)) +
    geom_line(color = colores_trat[tr], size = 0.6, alpha = 0.6, na.rm = TRUE) +
    geom_point(color = colores_trat[tr], size = 0.8, alpha = 0.8, na.rm = TRUE) +
    geom_text(
      data = ultimos_dac,
      aes(label = planta),
      hjust = -0.1, vjust = 0.5, size = 3,
      color = colores_trat[tr], fontface = "bold"
    ) +
    scale_x_date(
      date_labels = "%b %d", date_breaks = "2 weeks",
      expand = expansion(mult = c(0.02, 0.12))
    ) +
    labs(
      title = paste0("Perfil de DAC – Tratamiento ", tr),
      x = "Fecha", y = "DAC (mm)"
    ) +
    theme_minimal(base_size = 12) +
    theme(
      plot.title  = element_text(size = 14, face = "bold", hjust = 0.5),
      axis.text.x = element_text(angle = 45, vjust = 0.6),
      panel.grid.minor = element_blank()
    )

  print(p_dac)
  ggsave(
    file.path(dir_out, paste0("perfil_dac_", tr, ".png")),
    p_dac, width = 7, height = 5, dpi = 300
  )
}

```

```{r}
# --- Proporción de plantas completadas: gráfico combinado DAC vs Altura ---
# Calcular número total de fechas del experimento
total_fechas <- n_distinct(sheet_info$fecha)

# Función para calcular proporción por variable
calc_prop <- function(var) {
  med_clean %>%
    filter(variable == var, !is.na(valor)) %>%
    distinct(tratamiento, planta, fecha) %>%
    group_by(tratamiento, planta) %>%
    summarise(n_fechas = n_distinct(fecha), .groups = "drop") %>%
    mutate(completa = n_fechas == total_fechas) %>%
    group_by(tratamiento) %>%
    summarise(
      total     = n(),
      completas = sum(completa),
      propor    = completas / total * 100,
      .groups   = "drop"
    ) %>%
    mutate(propor_int = round(propor), variable = var)
}

# Datos combinados para DAC y Altura
df_prop <- bind_rows(calc_prop("dac"), calc_prop("altura"))

# Definir paleta para variables
auto_palette <- c("dac" = "#2A9D8F", "altura" = "#D62828")

# Gráfico combinado
p_prop <- ggplot(df_prop, aes(x = tratamiento, y = propor_int, fill = variable)) +
  geom_col(position = position_dodge(width = 0.7), width = 0.6, na.rm = TRUE) +
  geom_text(aes(label = paste0(propor_int, "%")),
            position = position_dodge(width = 0.7), vjust = -0.5, size = 4) +
  scale_fill_manual(values = auto_palette, labels = c("DAC", "Altura")) +
  scale_y_continuous(expand = expansion(c(0, 0.1))) +
  labs(
    title    = "Proporción de plantas completadas por tratamiento",
    subtitle = "Comparación de DAC vs Altura",
    x        = "Tratamiento",
    y        = "% completadas",
    fill     = "Variable"
  ) +
  theme_minimal(base_size = 12) +
  theme(
    plot.title    = element_text(face = "bold", hjust = 0.5),
    plot.subtitle = element_text(hjust = 0.5),
    legend.position = "top"
  )

# Mostrar y guardar
ggsave(
  filename = file.path(plots_dir, "proporcion_combinada.png"),
  plot     = p_prop,
  width    = 7,
  height   = 5,
  dpi      = 300
)
print(p_prop)


```
```{r}
tabla_llegada %>%
  group_by(tratamiento) %>%
  summarise(
    total = n(),
    llegaron = sum(tiene_final),
    proporcion = llegaron / total
  )

tabla_chi <- tabla_llegada %>%
  group_by(tratamiento, tiene_final) %>%
  summarise(n = n(), .groups = "drop") %>%
  pivot_wider(names_from = tiene_final, values_from = n, values_fill = 0) %>%
  column_to_rownames("tratamiento") %>%
  as.matrix()

print(tabla_chi)
chisq.test(tabla_chi)

```


















