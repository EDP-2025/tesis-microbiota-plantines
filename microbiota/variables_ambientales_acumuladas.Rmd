library(readxl)
library(dplyr)
library(lubridate)
library(writexl)

# 1) Leer los datos cada 10 min y convertir tipos
meteo <- read_excel("C:/Users/Gabriela Gutierrez/Downloads/RedMeteo.xlsx") %>%
  mutate(
    datetime        = ymd_hms(fecha_hora),
    date            = as_date(datetime),
    temperatura     = as.numeric(temperatura),
    humedad         = as.numeric(humedad),
    radiacion_solar = as.numeric(radiacion_solar),
    lluviadiaria    = as.numeric(lluviadiaria)
  )

# 2) Agregar por día, después de convertir a numérico
diario <- meteo %>%
  group_by(date) %>%
  summarise(
    temp_mean  = mean(temperatura,     na.rm = TRUE),
    hum_mean   = mean(humedad,         na.rm = TRUE),
    rad_mean   = mean(radiacion_solar, na.rm = TRUE),
    lluvia_sum = sum(lluviadiaria,     na.rm = TRUE),
    .groups    = "drop"
  ) %>%
  arrange(date)

# 3) Fechas donde mediste las plantas
fechas_plantas <- sort(unique(df_lme_clean$fecha))

# 4) Para cada fecha, acumular desde el inicio hasta ese día
env_acumulado <- lapply(fechas_plantas, function(f) {
  sub <- diario %>% filter(date <= f)
  tibble(
    fecha            = f,
    temp_mean_cum    = mean(sub$temp_mean,  na.rm = TRUE),
    humedad_mean_cum = mean(sub$hum_mean,    na.rm = TRUE),
    rad_mean_cum     = mean(sub$rad_mean,    na.rm = TRUE),
    lluvia_sum_cum   = sum(sub$lluvia_sum,   na.rm = TRUE)
  )
}) %>% bind_rows()

# 5) Escribir un nuevo Excel con las covariables acumuladas
write_xlsx(env_acumulado,
           "C:/Users/Gabriela Gutierrez/Downloads/env_acumulado_plantas.xlsx")
